# StampFly アーキテクチャ設計書

## 1. システム概要

StampFlyは、マイコンベースの飛行制御システムで、以下の主要コンポーネントで構成されています：

- 飛行制御ユニット（StampFly）
- コントローラー（ATOMJoy）
- センサー群
- モーター制御システム

## 2. ハードウェアアーキテクチャ

### 2.1 メインコンポーネント
- マイコン：飛行制御用プロセッサ
- IMUセンサー：姿勢検出用
- 高度センサー：高度維持モード用
- ワイヤレス通信モジュール：コントローラとの通信用
- モーター制御回路：PWM制御

### 2.2 電源システム
- バッテリー管理
- 電圧監視
- 保護回路

## 3. ソフトウェアアーキテクチャ

### 3.1 コアモジュール
```
StampFly/
├── src/
│   ├── main.cpp           # メインエントリーポイント
│   ├── flight_control/    # 飛行制御モジュール
│   ├── sensors/          # センサー制御
│   ├── motor/           # モーター制御
│   └── communication/   # 通信制御
└── lib/                 # 外部ライブラリ
```

### 3.2 主要クラス構成
- FlightController：飛行制御のメインクラス
- SensorManager：センサーデータ管理
- MotorController：モーター制御
- CommunicationManager：通信制御
- StateManager：状態管理

### 3.3 制御フロー
1. センサーデータ取得
2. 姿勢推定
3. 制御計算
4. モーター出力制御

## 4. 通信プロトコル

### 4.1 コントローラ通信
- プロトコル：無線通信
- データフォーマット：バイナリ
- 通信周期：高速更新

### 4.2 制御コマンド
- Arming/DisArming
- 飛行制御命令
- モード切替
- テレメトリデータ

## 5. 状態管理

### 5.1 飛行モード
- IDLE：待機状態
- ARMED：飛行準備完了
- FLYING：飛行中
- LANDING：着陸中
- ERROR：エラー状態

### 5.2 センサーキャリブレーション
1. 初期化フェーズ
2. オフセット計算
3. 較正完了

## 6. 安全機能

### 6.1 フェールセーフ
- バッテリー低下検知
- 通信切断検知
- 異常姿勢検知

### 6.2 緊急処理
- 自動着陸シーケンス
- モーター緊急停止
- エラー通知

## 7. 拡張性

### 7.1 将来の拡張
- 自動飛行機能
- GPS対応
- 高度な飛行モード

### 7.2 インターフェース
- 外部センサー追加
- 新規制御モード追加
- テレメトリ拡張
